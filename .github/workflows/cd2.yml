name: Build SymEngine on Windows

on:
  push:
    branches: [ main, symengine ]
  pull_request:
    branches: [ main, symengine ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      VCPKG_BINARY_SOURCES: 'clear;x-gha,readwrite'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11

      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Install dependencies with vcpkg
        run: |
          vcpkg install gmp:x64-windows mpfr:x64-windows
        shell: bash

      - name: Cache SymEngine build
        uses: actions/cache@v4
        with:
          path: |
            build
          key: ${{ runner.os }}-symengine-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-symengine-

      - name: Configure SymEngine
        run: |
          cmake -B build -S . \
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
            -DCMAKE_BUILD_TYPE=Release \
            -DWITH_GMP=ON \
            -DWITH_MPFR=ON \
            -DBUILD_TESTS=OFF \
            -DBUILD_BENCHMARKS=OFF
        shell: bash

      - name: Build SymEngine
        run: cmake --build build --config Release --parallel
        shell: bash

      - name: Test SymEngine (optional)
        run: |
          cd build
          ctest -C Release --output-on-failure
        shell: bash
        continue-on-error: true
